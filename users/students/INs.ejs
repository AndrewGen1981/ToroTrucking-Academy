<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TTA | INs</title>

    <link rel="shortcut icon" href="../../static/images/thumb.png">
    
    <!-- Styles -->
    <link rel="stylesheet" href="../../static/css/fonts.css">
    <link rel="stylesheet" href="../../static/css/brix-family.css">

    <link rel="stylesheet" href="../../static/css/colors.css">

    <link rel="stylesheet" href="/users/students/INs.css">

</head>
<body>
    
    <% function printTime24(date) { return new Date(date).toLocaleTimeString('en-US', { timeZone: 'America/Los_Angeles', hour12: false }) } %>

    <div class="ins-list-box">

        <% if(inStudents) { %>
            <header class="ins-list-header">
                <h2 class='ins-title'>Clocked in as of <%= new Date().toLocaleDateString('en-US', { timeZone: 'America/Los_Angeles' }) %></h2>
                <nav>
                    <a class='-btn' href="/admin/profile/" title='HOME'>
                        <i class="fas fa-home"></i>
                    </a>
                    <a class='-btn' href="/admin/student/list" title='Student List'>
                        <i class="fas fa-address-book"></i>
                    </a>
                    <a class='-btn' href="/admin/user-area" title='Users Area'>
                        <i class="fas fa-users"></i>
                    </a>
                    <a class='-btn' id='reload-ins' href="/admin/student/" title='Reload INs'>
                        <i class="fas fa-sync-alt"></i>
                    </a>
                </nav>
            </header>

            <div class="student-list-row" id="fixed-headers-row">
                <div class='field -name -header -left-color-group'>Student Name</div>

                <div class='field -key -header -left-color-group'>Key</div>
                <div class='field -location -header -left-color-group'>Location</div>

                <div class='field -TTT -header -left-color-group'>TTT</div>

                <div class="field -presentStatus -header -clock-color-group">Status</div>
                <div class="field -in -header -clock-color-group">Clock IN</div>
                <div class="field -out -header -clock-color-group">Clock OUT</div>

                <div class="field -incab-scoring -header -right-color-group">IN-CAB Scoring</div>
                <div class="field -outcab-scoring -header -right-color-group">OUT-CAB Scoring</div>
                <div class="field -backing-scoring -header -right-color-group">Backing Scoring</div>
                <div class="field -city-scoring -header -right-color-group">City Scoring</div>
            </div>  <!-- titles -->

            <% if(inStudents.length > 0) { %>


                <% inStudents.map((student, index) => { %>
                    
                    <div class="student-list-row" id='student-row-<%= index %>' data-student='<%= student._id %>' data-dataColl='<%= student.user.dataCollection._id %>'>

                        <% let name = `${student.user.dataCollection.firstName} ${student.user.dataCollection.lastName}` %>
                        <a href='/admin/user/<%= student.user._id %>' class='field -name'><%= name %></a>

                        <div class='field -key'><%= student.key %></div>
                        <div class='field -location'><%= student.location %></div>
                        <div class='field -TTT'><%= Math.trunc(student.TTT) %>h</div>
                        
                        <% if (student.clocks.length % 2 === 0) { %>    <!-- EVEN: last is clock out -->

                            <div class='field -presentStatus'>OUT</div>
                            
                            <% let clockIN = student.clocks[student.clocks.length - 2] %>
                            <% let clockOUT = student.clocks[student.clocks.length - 1] %>

                            <% if (!isNaN(clockIN.lat) && !isNaN(clockIN.lon)) { %>
                                <a class='field -clocks -in' href="http://www.google.com/maps/place/<%= clockIN.lat %>,<%= clockIN.lon %>" target="_blank">
                                    <%= printTime24(clockIN.date) %>
                                </a>
                            <% } else { %>
                                <a class='field -clocks -in' target="_blank"><%= printTime24(clockIN.date) %></a>
                            <% } %>


                            <% if (!isNaN(clockOUT.lat) && !isNaN(clockOUT.lon)) { %>
                                <a class='field -clocks -out -not-present' href="http://www.google.com/maps/place/<%= clockOUT.lat %>,<%= clockOUT.lon %>" target="_blank">
                                    <%= printTime24(clockOUT.date) %>
                                </a>
                            <% } else { %>
                                <a class='field -clocks -out -not-present' target="_blank"><%= printTime24(clockOUT.date) %></a>
                            <% } %>


                        <% } else { %>  <!-- ODD: last is clock in -->

                            <div class='field -presentStatus'>IN</div>

                            <% let clockIN = student.clocks[student.clocks.length - 1] %>

                            <% if (!isNaN(clockIN.lat) && !isNaN(clockIN.lon)) { %>
                                <a class='field -clocks -in' href="http://www.google.com/maps/place/<%= clockIN.lat %>,<%= clockIN.lon %>" target="_blank">
                                    <%= printTime24(clockIN.date) %>
                                </a>
                            <% } else { %>
                                <a class='field -clocks -in' target="_blank"><%= printTime24(clockIN.date) %></a>
                            <% } %>

                            <a class='field -clocks -out' target="_blank">...</a>
                        <% } %>


                        <!-- Scorings -->
                        <% let test1Info = 'submit' %>
                        <% let test2Info = 'submit' %>
                        <% let test3Info = 'submit' %>
                        <% let test4Info = 'submit' %>

                        <% if (student.scoring) { %>
                            <% function getInfo(arr){ return arr.length ? `${arr.length} (${new Date(arr[arr.length-1].created).toLocaleDateString('en-US', { timeZone: 'America/Los_Angeles' })})` : 'submit' } %>

                            <% test1Info = getInfo(student.scoring.scoringsInCab) %>
                            <% test2Info = getInfo(student.scoring.scoringsOutCab) %>
                            <% test3Info = getInfo(student.scoring.scoringsBacking) %>
                            <% test4Info = getInfo(student.scoring.scoringsCity) %>
                        <% } %>

                        <form method='POST' action="/admin/inst/incab" class='field -incab-scoring'>
                            <input type="hidden" name="studentId" value="<%= student._id %>" />
                            <button class='-btn-scoring' type="submit" data-test='student-row-<%= index %>'><%= test1Info %></button>
                        </form>
                        <form method='POST' action="/admin/inst/outcab" class='field -outcab-scoring'>
                            <input type="hidden" name="studentId" value="<%= student._id %>" />
                            <button class='-btn-scoring' type="submit" data-test='student-row-<%= index %>'><%= test2Info %></button>
                        </form>
                        <form method='POST' action="/admin/inst/backing" class='field -backing-scoring'>
                            <input type="hidden" name="studentId" value="<%= student._id %>" />
                            <button class='-btn-scoring' type="submit" data-test='student-row-<%= index %>'><%= test3Info %></button>
                        </form>
                        <form method='POST' action="/admin/inst/city" class='field -city-scoring'>
                            <input type="hidden" name="studentId" value="<%= student._id %>" />
                            <button class='-btn-scoring' type="submit" data-test='student-row-<%= index %>'><%= test4Info %></button>
                        </form>
                        

                    </div>  <!-- student-list-row -->
                <% }) %>

            <% } else { %>
                <div class="student-list-row" id='student-row-0' name='empty-list'>
                    <div class="empty-list">so far no one is there...</div>
                </div>
            <% } %>
        <% } %>     <!-- if inStudents is defined -->

    </div>  <!-- ins-list-box -->


    <script>
        
        // selecting not present already
        function disableAllWhoOut() {
            let rowElement, testButtons
            const allOUTs = document.querySelectorAll('.-out')

            if (allOUTs) {
                for (let i=allOUTs.length-1; i > -1; i--) {     // backwards fastest
                    rowElement = allOUTs[i].parentElement
                    testButtons = rowElement.querySelectorAll(`[data-test=${rowElement.id}]`)

                    if (allOUTs[i].classList.contains('-not-present')) {
                        rowElement.classList.add('-not-present')
                        testButtons.forEach(testBtn => {    // student out, make scoring's buttons unclickable
                            testBtn.type = 'button'
                            testBtn.classList.add('-not-active')
                            if (testBtn.textContent === 'submit') { testBtn.textContent = 'NO'}
                        })
                    } else {
                        rowElement.classList.remove('-not-present')
                        testButtons.forEach(testBtn => {    // student in, restore scoring's buttons functionality
                            testBtn.type = 'submit'
                            testBtn.classList.remove('-not-active')
                            if (testBtn.textContent === 'NO') { testBtn.textContent = 'submit'}
                        })
                    }
                }
            }
        }


        // @ENTERY POINT
        disableAllWhoOut()

    </script>


    <script type="module" defer>

        // @NOTIFICATIONS from db
        import { io } from "https://cdn.socket.io/4.3.2/socket.io.esm.min.js"
        const socket = io("/")


        // server emits, so have to check if changes are related to this particular client
        // @WHEN Students changed
        socket.on('students-update', student => {
            if (student) {

                // if list was empty, then 1st row 'so far no one is there...' should be deleted
                const emptyList = document.getElementsByClassName('empty-list')[0]
                if (emptyList) {
                    document.querySelector('#reload-ins').click()
                    return
                }

                // document.querySelector('#reload-user-area').click()

                const id = student.documentKey._id
                if (student.operationType === "update") {
                    const updatedRow = document.querySelector(`[data-student='${id}']`)
                    if (updatedRow != null) {
                        const fields = student.updateDescription.updatedFields
                        for (const [key, value] of Object.entries(fields)) {
                            let el = updatedRow.querySelector(`.-${key}`)
                            if (el) {
                                switch (key) {
                                    case 'TTT':
                                        el.textContent = `${Math.trunc(value)}h:${Math.round(60*(value % 1))}m`
                                    break
                                    case 'clocks':
                                        let elIN = updatedRow.querySelector('.-in')
                                        let elOUT = updatedRow.querySelector('.-out')

                                        let lastClock = value[value.length - 1]
                                        let todaysClocks = value.filter(item => { return item.key === lastClock.key })

                                        if (todaysClocks.length % 2 === 0) {    //  EVEN: last is clock out
                                            if (!isNaN(lastClock.lat) && !isNaN(lastClock.lon)) {
                                                elOUT.href = `http://www.google.com/maps/place/${lastClock.lat},${lastClock.lon}`
                                            } else {
                                                elOUT.removeAttribute("href")
                                            }
                                            elOUT.textContent = new Date(lastClock.date).toLocaleTimeString('en-US', { timeZone: 'America/Los_Angeles', hour12: false })
                                            elOUT.classList.add('-not-present')
                                        } else {
                                            if (!isNaN(lastClock.lat) && !isNaN(lastClock.lon)) {
                                                elIN.href = `http://www.google.com/maps/place/${lastClock.lat},${lastClock.lon}`
                                            } else {
                                                elIN.removeAttribute("href")
                                            }
                                            elIN.textContent = new Date(lastClock.date).toLocaleTimeString('en-US', { timeZone: 'America/Los_Angeles', hour12: false })
                                            elOUT.textContent ='...'    // if returned back
                                            elOUT.removeAttribute("href")
                                            elOUT.classList.remove('-not-present')
                                        }

                                        disableAllWhoOut()

                                    break
                                    default: el.textContent = value
                                }
                            }
                        }
                    }  else {    // new one came, indicate him
                        document.querySelector('#reload-ins').click()
                    }  // updatedRow != null

                }   // operation is update
            }   // if student is defined
        })  // socket.on('students-update')

    </script>

</body>
</html>