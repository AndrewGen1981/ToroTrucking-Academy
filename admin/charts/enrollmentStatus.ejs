<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TTA | Chart: Enrollments Dynamics</title>

    <link rel="shortcut icon" href="/static/images/thumb.png">
        
    <!-- Styles -->
    <link rel="stylesheet" href="/static/css/fonts.css">
    <link rel="stylesheet" href="/static/css/brix-family.css">
        
    <link rel="stylesheet" href="/admin/charts/enrollmentStatus.css">
</head>
<body>

    <!-- each location has own color for Chart -->
    <% const colorArray = ['black', 'red', 'orange', 'yellow', 'green', 'cyan', 'blue', 'purple'] %>

    <header>
        <h3 class="header-title">Chart: Enrollments Dynamics</h3>
        <menu>
            <%- include('../../static/partial/--admin-menu.ejs') %>
        </menu>
    </header>

    <div class="dummy"></div>

    <% if(locals.chartData || locals.chartData.length) { %>
        <section class="chart-box" id="passed-chart">
            <h3 class="chart-title">Dynamics of <span>Graduate students</span> per locations</h3>
            <div class="analythicsChart" id="analythics-cart-passed">
                <% chartData.map(item => { %>
                    <% let qty = item.locationPassed.reduce((a,b) => b += a) %>
                    <div class="chart-column" data-key="<%= item.month %>.<%= item.year %>" data-value="<%= qty %>">
                        <% if(qty > 0) { %>
                            <% item.locations.map((location, index) => { %>
                                <% if(item.locationPassed[index] > 0) { %>
                                    <% let perc = item.locationPassed[index] *100 / qty %>
                                    <% let href = `/admin/student/shortlist?year=${item.year}&month=${item.month}&location=${location}&graduate=passed` %>
                                    <% let title = `${location} - ${item.locationPassed[index]}` %>
                                    <a href='<%= href %>' class="chart-sub-column" data-value="<%= item.locationPassed[index] %>" style="--h:<%= perc %>%; --c:<%= colorArray[index - 1] %>" title="<%= title %>"><%= Math.round(perc) %>%</a>  <!-- use index-1 because 0th el. is 'All' -->
                                <% } %>
                            <% }) %>
                        <% } %>
                    </div>
                <% }) %>
            </div>  <!-- analythicsChart -->
        </section>      <!-- chart-box -->


        <section class="chart-box" id="failed-chart">
            <h3 class="chart-title">Dynamics of <span>Failed students</span> per locations</h3>
            <div class="analythicsChart" id="analythics-cart-failed">
                <% chartData.map(item => { %>
                    <% let qty = item.locationFailed.reduce((a,b) => b += a) %>
                    <div class="chart-column" data-key="<%= item.month %>.<%= item.year %>" data-value="<%= qty %>">
                        <% if(qty > 0) { %>
                            <% item.locations.map((location, index) => { %>
                                <% if(item.locationFailed[index] > 0) { %>
                                    <% let perc = item.locationFailed[index] *100 / qty %>
                                    <% let href = `/admin/student/shortlist?year=${item.year}&month=${item.month}&location=${location}&graduate=failed` %>
                                    <% let title = `${location} - ${item.locationFailed[index]}` %>
                                    <a href='<%= href %>' class="chart-sub-column" data-value="<%= item.locationFailed[index] %>" style="--h:<%= perc %>%; --c:<%= colorArray[index - 1] %>" title="<%= title %>"><%= Math.round(perc) %>%</a>  <!-- use index-1 because 0th el. is 'All' -->
                                <% } %>
                            <% }) %>
                        <% } %>
                    </div>
                <% }) %>
            </div>  <!-- analythicsChart -->
        </section>      <!-- chart-box -->


        <section class="chart-box" id="declined-chart">
            <h3 class="chart-title">Dynamics of <span>Declined students</span> per locations</h3>
            <div class="analythicsChart" id="analythics-cart-declined">
                <% chartData.map(item => { %>
                    <% let qty = item.locationDeclined.reduce((a,b) => b += a) %>
                    <div class="chart-column" data-key="<%= item.month %>.<%= item.year %>" data-value="<%= qty %>">
                        <% if(qty > 0) { %>
                            <% item.locations.map((location, index) => { %>
                                <% if(item.locationDeclined[index] > 0) { %>
                                    <% let perc = item.locationDeclined[index] *100 / qty %>
                                    <% let href = `/admin/student/shortlist?year=${item.year}&month=${item.month}&location=${location}&graduate=declined` %>
                                    <% let title = `${location} - ${item.locationDeclined[index]}` %>
                                    <a href='<%= href %>' class="chart-sub-column" data-value="<%= item.locationDeclined[index] %>" style="--h:<%= perc %>%; --c:<%= colorArray[index - 1] %>" title="<%= title %>"><%= Math.round(perc) %>%</a>  <!-- use index-1 because 0th el. is 'All' -->
                                <% } %>
                            <% }) %>
                        <% } %>
                    </div>
                <% }) %>
            </div>  <!-- analythicsChart -->
        </section>      <!-- chart-box -->


        <section class="chart-box" id="military-chart">
            <h3 class="chart-title">Dynamics of <span>Military leave of absence</span> per locations</h3>
            <div class="analythicsChart" id="analythics-cart-military">
                <% chartData.map(item => { %>
                    <% let qty = item.locationMilitary.reduce((a,b) => b += a) %>
                    <div class="chart-column" data-key="<%= item.month %>.<%= item.year %>" data-value="<%= qty %>">
                        <% if(qty > 0) { %>
                            <% item.locations.map((location, index) => { %>
                                <% if(item.locationMilitary[index] > 0) { %>
                                    <% let perc = item.locationMilitary[index] *100 / qty %>
                                    <% let href = `/admin/student/shortlist?year=${item.year}&month=${item.month}&location=${location}&graduate=military` %>
                                    <% let title = `${location} - ${item.locationMilitary[index]}` %>
                                    <a href='<%= href %>' class="chart-sub-column" data-value="<%= item.locationMilitary[index] %>" style="--h:<%= perc %>%; --c:<%= colorArray[index - 1] %>" title="<%= title %>"><%= Math.round(perc) %>%</a>  <!-- use index-1 because 0th el. is 'All' -->
                                <% } %>
                            <% }) %>
                        <% } %>
                    </div>
                <% }) %>
            </div>  <!-- analythicsChart -->
        </section>      <!-- chart-box -->


        <section class="chart-box -mt">
            <h3 class="chart-title">Dynamics of <span>Skills test results</span> per locations</h3>
            <div class="analythicsTable">
                <!-- 1st Column -->
                <% const item1 = chartData[0] %>
                <div class="table-left-column">
                    <div class="table-header">Periods</div>
                    <div class="table-value -total">Totals</div>
                    
                    <div class="table-value -group">Initial</div>
                    <% item1.locations.forEach(location => { %>
                        <% if(location != "All" && location != "UNSET") { %>
                            <div class="table-value -subvalue"><%= location %></div>
                        <% } %>
                    <% }) %>

                    <div class="table-value -group">Retest *</div>
                    <% item1.locations.forEach(location => { %>
                        <% if(location != "All" && location != "UNSET") { %>
                            <div class="table-value -subvalue"><%= location %></div>
                        <% } %>
                    <% }) %>

                    <div class="table-value -group">Retest Bk & Rd</div>
                    <% item1.locations.forEach(location => { %>
                        <% if(location != "All" && location != "UNSET") { %>
                            <div class="table-value -subvalue"><%= location %></div>
                        <% } %>
                    <% }) %>

                    <div class="table-value -group">Retest Rd only</div>
                    <% item1.locations.forEach(location => { %>
                        <% if(location != "All" && location != "UNSET") { %>
                            <div class="table-value -subvalue"><%= location %></div>
                        <% } %>
                    <% }) %>

                </div>


                <% chartData.forEach(item => { %>
                    <% 
                        let qtyInitial = item.locationInitial.reduce((a,b) => b += a)
                        let qtyRetest = item.locationRetest.reduce((a,b) => b += a)
                        let qtyRetestBKnRD = item.locationRetestBKnRD.reduce((a,b) => b += a)
                        let qtyRetestRDonly = item.locationRetestRDonly.reduce((a,b) => b += a)
                        let total = qtyInitial + qtyRetest + qtyRetestBKnRD + qtyRetestRDonly

                        let link = `/admin/student/skills-details?year=${item.year}&month=${item.indexMonth + 1}`
                    %>
                    <div class="table-column">
                        <div class="table-header"><%= item.month %>.<%= item.year %></div>
                        <div class="table-value -total" data-tabvalue="<%= total %>"><%= total %></div>
                        
                        <a class="table-value -group" data-tabvalue="<%= qtyInitial %>" href="<%= link %>"><%= qtyInitial %></a>
                        <% item.locations.forEach((location, index) => { %>
                            <% if(location != "All" && location != "UNSET") { %>
                                <div class="table-value -subvalue" data-tabvalue="<%= item.locationInitial[index] %>"><%= item.locationInitial[index] %></div>
                            <% } %>
                        <% }) %>

                        <a class="table-value -group" data-tabvalue="<%= qtyRetest %>" href="<%= link %>"><%= qtyRetest %></a>
                        <% item.locations.forEach((location, index) => { %>
                            <% if(location != "All" && location != "UNSET") { %>
                                <div class="table-value -subvalue" data-tabvalue="<%= item.locationRetest[index] %>"><%= item.locationRetest[index] %></div>
                            <% } %>
                        <% }) %>

                        <a class="table-value -group" data-tabvalue="<%= qtyRetestBKnRD %>" href="<%= link %>"><%= qtyRetestBKnRD %></a>
                        <% item.locations.forEach((location, index) => { %>
                            <% if(location != "All" && location != "UNSET") { %>
                                <div class="table-value -subvalue" data-tabvalue="<%= item.locationRetestBKnRD[index] %>"><%= item.locationRetestBKnRD[index] %></div>
                            <% } %>
                        <% }) %>

                        <a class="table-value -group" data-tabvalue="<%= qtyRetestRDonly %>" href="<%= link %>"><%= qtyRetestRDonly %></a>
                        <% item.locations.forEach((location, index) => { %>
                            <% if(location != "All" && location != "UNSET") { %>
                                <div class="table-value -subvalue" data-tabvalue="<%= item.locationRetestRDonly[index] %>"><%= item.locationRetestRDonly[index] %></div>
                            <% } %>
                        <% }) %>

                    </div>


                <% }) %>
            </div>  <!-- analythicsTable -->
            <div class="table-note">* "Retest" doesn't include "Retest Bk & Rd" and "Retest Rd only" skills test</div>
        </section>      <!-- chart-box -->


    <% } else { %>
        <h3>No data passed</h3>
    <% } %>


    <script defer>

        // @drawing chart
        // get chart div height depending on vh
        const charts = document.querySelectorAll(".analythicsChart")

        if (charts) {
            charts.forEach(chart => {
                const maxHeight = parseFloat(getComputedStyle(chart).height)
                const cols = chart.querySelectorAll(".chart-column")
                if (maxHeight && cols) {
                    // find max value
                    let max = 0
                    for (let i=0; i<cols.length; i++) {
                        if (parseInt(cols[i].dataset.value) > max) { max = parseInt(cols[i].dataset.value) }
                    }
                    if (max) {
                        // setting values espectively to max                    
                        for (let i=0; i<cols.length; i++) {
                            cols[i].style.height = `${ parseInt(cols[i].dataset.value) * maxHeight / max }px`
                        }
                    }
                }
            })
        }

    </script>

</body>
</html>